# Apache Configuration for Open Lovable PWA
# This configuration provides optimal PWA support with HTTPS

<VirtualHost *:80>
    ServerName open-lovable.vercel.app
    Redirect permanent / https://open-lovable.vercel.app/
</VirtualHost>

<VirtualHost *:443>
    ServerName open-lovable.vercel.app
    DocumentRoot /var/www/open-lovable
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/open-lovable.crt
    SSLCertificateKeyFile /etc/ssl/private/open-lovable.key
    
    # SSL Security Settings
    SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384
    SSLHonorCipherOrder on
    SSLCompression off
    
    # Security Headers
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set X-Download-Options "noopen"
    Header always set X-Permitted-Cross-Domain-Policies "none"
    
    # PWA Specific Headers
    Header always set X-Web-App-Capable "yes"
    Header always set X-Web-App-Status-Bar-Style "default"
    Header always set X-Web-App-Title "Open Lovable"
    
    # Compression
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/plain
        AddOutputFilterByType DEFLATE text/html
        AddOutputFilterByType DEFLATE text/xml
        AddOutputFilterByType DEFLATE text/css
        AddOutputFilterByType DEFLATE application/xml
        AddOutputFilterByType DEFLATE application/xhtml+xml
        AddOutputFilterByType DEFLATE application/rss+xml
        AddOutputFilterByType DEFLATE application/javascript
        AddOutputFilterByType DEFLATE application/x-javascript
        AddOutputFilterByType DEFLATE application/json
        AddOutputFilterByType DEFLATE application/manifest+json
    </IfModule>
    
    # Caching
    <IfModule mod_expires.c>
        ExpiresActive on
        
        # PWA Manifest
        ExpiresByType application/manifest+json "access plus 1 hour"
        
        # Service Worker
        ExpiresByType application/javascript "access plus 0 seconds"
        
        # Offline page
        ExpiresByType text/html "access plus 1 hour"
        
        # Icons and images
        ExpiresByType image/png "access plus 1 year"
        ExpiresByType image/jpg "access plus 1 year"
        ExpiresByType image/jpeg "access plus 1 year"
        ExpiresByType image/gif "access plus 1 year"
        ExpiresByType image/ico "access plus 1 year"
        ExpiresByType image/svg+xml "access plus 1 year"
        
        # Static assets
        ExpiresByType text/css "access plus 1 year"
        ExpiresByType application/javascript "access plus 1 year"
        
        # HTML files
        ExpiresByType text/html "access plus 1 hour"
    </IfModule>
    
    # PWA Manifest
    <Files "manifest.json">
        Header set Content-Type "application/manifest+json"
        Header set Cache-Control "public, max-age=3600"
        Header set Access-Control-Allow-Origin "*"
    </Files>
    
    # Service Worker
    <Files "sw.js">
        Header set Content-Type "application/javascript"
        Header set Cache-Control "public, max-age=0, must-revalidate"
        Header set Service-Worker-Allowed "/"
        Header set Access-Control-Allow-Origin "*"
    </Files>
    
    # Offline page
    <Files "offline.html">
        Header set Content-Type "text/html"
        Header set Cache-Control "public, max-age=3600"
    </Files>
    
    # Icons directory
    <Directory "/var/www/open-lovable/icons">
        Header set Cache-Control "public, immutable"
        Header set Access-Control-Allow-Origin "*"
        Options -Indexes
    </Directory>
    
    # Static assets
    <Directory "/var/www/open-lovable/_next">
        Header set Cache-Control "public, immutable"
        Header set Access-Control-Allow-Origin "*"
        Options -Indexes
    </Directory>
    
    # API routes (if needed for future)
    <Location "/api/">
        Header set Access-Control-Allow-Origin "*"
        Header set Access-Control-Allow-Methods "GET, POST, OPTIONS"
        Header set Access-Control-Allow-Headers "Content-Type, Authorization"
        
        # Handle preflight requests
        RewriteEngine On
        RewriteCond %{REQUEST_METHOD} OPTIONS
        RewriteRule ^(.*)$ $1 [R=200,L]
    </Location>
    
    # Main application
    <Directory "/var/www/open-lovable">
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # SPA routing
        RewriteEngine On
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^(.*)$ /index.html [L]
    </Directory>
    
    # Error pages
    ErrorDocument 404 /404.html
    
    # Security: Block access to sensitive files
    <FilesMatch "^\.">
        Require all denied
    </FilesMatch>
    
    <FilesMatch "~$">
        Require all denied
    </FilesMatch>
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/open-lovable.error.log
    CustomLog ${APACHE_LOG_DIR}/open-lovable.access.log combined
    
    # Performance
    <IfModule mod_headers.c>
        Header set X-Content-Type-Options nosniff
        Header set X-Frame-Options DENY
        Header set X-XSS-Protection "1; mode=block"
    </IfModule>
</VirtualHost>

# Enable required modules
# LoadModule ssl_module modules/mod_ssl.so
# LoadModule headers_module modules/mod_headers.so
# LoadModule expires_module modules/mod_expires.so
# LoadModule deflate_module modules/mod_deflate.so
# LoadModule rewrite_module modules/mod_rewrite.so